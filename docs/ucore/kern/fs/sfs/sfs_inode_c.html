
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>sfs_inode.c · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-ancre-navigation/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../../../gitbook/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="sfs_io_c.html" />
    
    
    <link rel="prev" href="sfs_h.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../../../">
            
                <a href="../../../../">
            
                    
                    Introduction
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../../../../lab/lab1/">
            
                <a href="../../../../lab/lab1/">
            
                    
                    lab1
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.1" data-path="../../../../lab/lab1/boot/">
            
                <a href="../../../../lab/lab1/boot/">
            
                    
                    boot
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.1.1" data-path="../../../../lab/lab1/boot/bootasm.html">
            
                <a href="../../../../lab/lab1/boot/bootasm.html">
            
                    
                    bootasm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.1.2" data-path="../../../../lab/lab1/boot/bootmain.html">
            
                <a href="../../../../lab/lab1/boot/bootmain.html">
            
                    
                    bootmain
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.1.2" data-path="../../../../lab/lab1/kern/">
            
                <a href="../../../../lab/lab1/kern/">
            
                    
                    kern
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.2.1" data-path="../../../../lab/lab1/kern/debug/">
            
                <a href="../../../../lab/lab1/kern/debug/">
            
                    
                    debug
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.2.1.1" data-path="../../../../lab/lab1/kern/debug/kmonitor.html">
            
                <a href="../../../../lab/lab1/kern/debug/kmonitor.html">
            
                    
                    kmonitor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.2.1.2" data-path="../../../../lab/lab1/kern/debug/panic.html">
            
                <a href="../../../../lab/lab1/kern/debug/panic.html">
            
                    
                    panic
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.1.2.2" data-path="../../../../lab/lab1/kern/init/">
            
                <a href="../../../../lab/lab1/kern/init/">
            
                    
                    init
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.2.2.1" data-path="../../../../lab/lab1/kern/init/init.html">
            
                <a href="../../../../lab/lab1/kern/init/init.html">
            
                    
                    init
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.1.2.3" data-path="../../../../lab/lab1/kern/libs/">
            
                <a href="../../../../lab/lab1/kern/libs/">
            
                    
                    libs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.2.3.1" data-path="../../../../lab/lab1/kern/libs/readline.html">
            
                <a href="../../../../lab/lab1/kern/libs/readline.html">
            
                    
                    readline
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.1.2.4" data-path="../../../../lab/lab1/kern/mm/">
            
                <a href="../../../../lab/lab1/kern/mm/">
            
                    
                    mm
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.2.4.1" data-path="../../../../lab/lab1/kern/mm/pmm.html">
            
                <a href="../../../../lab/lab1/kern/mm/pmm.html">
            
                    
                    pmm
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.1.2.5" data-path="../../../../lab/lab1/kern/trap/">
            
                <a href="../../../../lab/lab1/kern/trap/">
            
                    
                    trap
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.2.5.1" data-path="../../../../lab/lab1/kern/trap/trap.html">
            
                <a href="../../../../lab/lab1/kern/trap/trap.html">
            
                    
                    trap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.2.5.2" data-path="../../../../lab/lab1/kern/trap/trapentry.html">
            
                <a href="../../../../lab/lab1/kern/trap/trapentry.html">
            
                    
                    trapentry
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.2.5.3" data-path="../../../../lab/lab1/kern/trap/vectors.html">
            
                <a href="../../../../lab/lab1/kern/trap/vectors.html">
            
                    
                    vectors
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.1.3" data-path="../../../../lab/lab1/libs/">
            
                <a href="../../../../lab/lab1/libs/">
            
                    
                    libs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.4" data-path="../../../../lab/lab1/tools/">
            
                <a href="../../../../lab/lab1/tools/">
            
                    
                    tools
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../../../labs/">
            
                <a href="../../../../labs/">
            
                    
                    LABS
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../../../labs/lab1.html">
            
                <a href="../../../../labs/lab1.html">
            
                    
                    lab1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../../../../labs/lab2.html">
            
                <a href="../../../../labs/lab2.html">
            
                    
                    lab2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../../../../labs/lab3.html">
            
                <a href="../../../../labs/lab3.html">
            
                    
                    lab3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../../../../labs/lab4.html">
            
                <a href="../../../../labs/lab4.html">
            
                    
                    lab4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../../../../labs/lab5.html">
            
                <a href="../../../../labs/lab5.html">
            
                    
                    lab5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../../../../labs/lab6.html">
            
                <a href="../../../../labs/lab6.html">
            
                    
                    lab6
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="../../../../labs/lab7.html">
            
                <a href="../../../../labs/lab7.html">
            
                    
                    lab7
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="../../../../labs/lab8.html">
            
                <a href="../../../../labs/lab8.html">
            
                    
                    lab8
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../../">
            
                <a href="../../../">
            
                    
                    uCore代码分析
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../../boot/">
            
                <a href="../../../boot/">
            
                    
                    boot
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../../../boot/asm_h.html">
            
                <a href="../../../boot/asm_h.html">
            
                    
                    asm.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="../../../boot/bootasm_S.html">
            
                <a href="../../../boot/bootasm_S.html">
            
                    
                    bootasm.S
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="../../../boot/bootmain_c.html">
            
                <a href="../../../boot/bootmain_c.html">
            
                    
                    bootmain.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.4" data-path="../../../boot/bootasm_S_lab1.html">
            
                <a href="../../../boot/bootasm_S_lab1.html">
            
                    
                    (lab1) bootasm.S
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../../">
            
                <a href="../../">
            
                    
                    kern
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="../../debug/">
            
                <a href="../../debug/">
            
                    
                    debug
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1.1" data-path="../../debug/assert_h.html">
            
                <a href="../../debug/assert_h.html">
            
                    
                    assert.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.1.2" data-path="../../debug/kdebug_c.html">
            
                <a href="../../debug/kdebug_c.html">
            
                    
                    kdebug.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.1.3" data-path="../../debug/kdebug_h.html">
            
                <a href="../../debug/kdebug_h.html">
            
                    
                    kdebug.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.1.4" data-path="../../debug/kmonitor_c.html">
            
                <a href="../../debug/kmonitor_c.html">
            
                    
                    kmonitor.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.1.5" data-path="../../debug/kmonitor_h.html">
            
                <a href="../../debug/kmonitor_h.html">
            
                    
                    kmonitor.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.1.6" data-path="../../debug/panic_c.html">
            
                <a href="../../debug/panic_c.html">
            
                    
                    panic.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.1.7" data-path="../../debug/stab_h.html">
            
                <a href="../../debug/stab_h.html">
            
                    
                    stab.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.1.8" data-path="../../debug/kdebug_c_lab1.html">
            
                <a href="../../debug/kdebug_c_lab1.html">
            
                    
                    (lab1) kdebug.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="../../driver/">
            
                <a href="../../driver/">
            
                    
                    driver
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.2.1" data-path="../../driver/clock_c.html">
            
                <a href="../../driver/clock_c.html">
            
                    
                    clock.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.2" data-path="../../driver/clock_h.html">
            
                <a href="../../driver/clock_h.html">
            
                    
                    clock.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.3" data-path="../../driver/console_c.html">
            
                <a href="../../driver/console_c.html">
            
                    
                    console.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.4" data-path="../../driver/console_h.html">
            
                <a href="../../driver/console_h.html">
            
                    
                    console.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.5" data-path="../../driver/ide_c.html">
            
                <a href="../../driver/ide_c.html">
            
                    
                    ide.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.6" data-path="../../driver/ide_h.html">
            
                <a href="../../driver/ide_h.html">
            
                    
                    ide.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.7" data-path="../../driver/intr_c.html">
            
                <a href="../../driver/intr_c.html">
            
                    
                    intr.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.8" data-path="../../driver/intr_h.html">
            
                <a href="../../driver/intr_h.html">
            
                    
                    intr.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.9" data-path="../../driver/kbdreg_h.html">
            
                <a href="../../driver/kbdreg_h.html">
            
                    
                    kbdreg.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.10" data-path="../../driver/picirq_c.html">
            
                <a href="../../driver/picirq_c.html">
            
                    
                    picirq.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2.11" data-path="../../driver/picirq_h.html">
            
                <a href="../../driver/picirq_h.html">
            
                    
                    picirq.h
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="../">
            
                <a href="../">
            
                    
                    fs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.3.1" data-path="../devs/">
            
                <a href="../devs/">
            
                    
                    devs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.3.1.1" data-path="../devs/dev_c.html">
            
                <a href="../devs/dev_c.html">
            
                    
                    dev.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.1.2" data-path="../devs/dev_disk0_c.html">
            
                <a href="../devs/dev_disk0_c.html">
            
                    
                    dev_disk0.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.1.3" data-path="../devs/dev_h.html">
            
                <a href="../devs/dev_h.html">
            
                    
                    dev.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.1.4" data-path="../devs/dev_stdin_c.html">
            
                <a href="../devs/dev_stdin_c.html">
            
                    
                    dev_stdin.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.1.5" data-path="../devs/dev_stdout_c.html">
            
                <a href="../devs/dev_stdout_c.html">
            
                    
                    dev_stdout.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.2" data-path="./">
            
                <a href="./">
            
                    
                    sfs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.3.2.1" data-path="bitmap_c.html">
            
                <a href="bitmap_c.html">
            
                    
                    bitmap.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.2.2" data-path="bitmap_h.html">
            
                <a href="bitmap_h.html">
            
                    
                    bitmap.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.2.3" data-path="sfs_c.html">
            
                <a href="sfs_c.html">
            
                    
                    sfs.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.2.4" data-path="sfs_fs_c.html">
            
                <a href="sfs_fs_c.html">
            
                    
                    sfs_fs.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.2.5" data-path="sfs_h.html">
            
                <a href="sfs_h.html">
            
                    
                    sfs.h
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.2.3.2.6" data-path="sfs_inode_c.html">
            
                <a href="sfs_inode_c.html">
            
                    
                    sfs_inode.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.2.7" data-path="sfs_io_c.html">
            
                <a href="sfs_io_c.html">
            
                    
                    sfs_io.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.2.8" data-path="sfs_lock_c.html">
            
                <a href="sfs_lock_c.html">
            
                    
                    sfs_lock.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.3" data-path="../swap/">
            
                <a href="../swap/">
            
                    
                    swap
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.3.3.1" data-path="../swap/swapfs_c.html">
            
                <a href="../swap/swapfs_c.html">
            
                    
                    swapfs.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.3.2" data-path="../swap/swapfs_h.html">
            
                <a href="../swap/swapfs_h.html">
            
                    
                    swapfs.h
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.4" data-path="../vfs/README.md">
            
                <span>
            
                    
                    vfs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.3.4.1" data-path="../vfs/inode_c.html">
            
                <a href="../vfs/inode_c.html">
            
                    
                    inode.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.4.2" data-path="../vfs/inode_h.html">
            
                <a href="../vfs/inode_h.html">
            
                    
                    inode.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.4.3" data-path="../vfs/README_md.html">
            
                <a href="../vfs/README_md.html">
            
                    
                    README.md
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.4.4" data-path="../vfs/vfs_c.html">
            
                <a href="../vfs/vfs_c.html">
            
                    
                    vfs.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.4.5" data-path="../vfs/vfsdev_c.html">
            
                <a href="../vfs/vfsdev_c.html">
            
                    
                    vfsdev.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.4.6" data-path="../vfs/vfsfile_c.html">
            
                <a href="../vfs/vfsfile_c.html">
            
                    
                    vfsfile.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.4.7" data-path="../vfs/vfs_h.html">
            
                <a href="../vfs/vfs_h.html">
            
                    
                    vfs.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.4.8" data-path="../vfs/vfslookup_c.html">
            
                <a href="../vfs/vfslookup_c.html">
            
                    
                    vfslookup.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.4.9" data-path="../vfs/vfspath_c.html">
            
                <a href="../vfs/vfspath_c.html">
            
                    
                    vfspath.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.5" data-path="../file_c.html">
            
                <a href="../file_c.html">
            
                    
                    file.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.6" data-path="../file_h.html">
            
                <a href="../file_h.html">
            
                    
                    file.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.7" data-path="../fs_c.html">
            
                <a href="../fs_c.html">
            
                    
                    fs.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.8" data-path="../fs_h.html">
            
                <a href="../fs_h.html">
            
                    
                    fs.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.9" data-path="../iobuf_c.html">
            
                <a href="../iobuf_c.html">
            
                    
                    iobuf.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.10" data-path="../iobuf_h.html">
            
                <a href="../iobuf_h.html">
            
                    
                    iobuf.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.11" data-path="../sysfile_c.html">
            
                <a href="../sysfile_c.html">
            
                    
                    sysfile.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3.12" data-path="../sysfile_h.html">
            
                <a href="../sysfile_h.html">
            
                    
                    sysfile.h
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.4" data-path="../../init/">
            
                <a href="../../init/">
            
                    
                    init
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.4.1" data-path="../../init/entry_S.html">
            
                <a href="../../init/entry_S.html">
            
                    
                    entry.S
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4.2" data-path="../../init/init_c.html">
            
                <a href="../../init/init_c.html">
            
                    
                    init.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4.3" data-path="../../init/init_c_lab1.html">
            
                <a href="../../init/init_c_lab1.html">
            
                    
                    (lab1) init.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.5" data-path="../../libs/">
            
                <a href="../../libs/">
            
                    
                    libs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.5.1" data-path="../../libs/readline_c.html">
            
                <a href="../../libs/readline_c.html">
            
                    
                    readline.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.5.2" data-path="../../libs/stdio_c.html">
            
                <a href="../../libs/stdio_c.html">
            
                    
                    stdio.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.5.3" data-path="../../libs/string_c.html">
            
                <a href="../../libs/string_c.html">
            
                    
                    string.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.6" data-path="../../mm/">
            
                <a href="../../mm/">
            
                    
                    mm
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.6.1" data-path="../../mm/default_pmm_c.html">
            
                <a href="../../mm/default_pmm_c.html">
            
                    
                    default_pmm.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.2" data-path="../../mm/default_pmm_h.html">
            
                <a href="../../mm/default_pmm_h.html">
            
                    
                    default_pmm.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.3" data-path="../../mm/kmalloc_c.html">
            
                <a href="../../mm/kmalloc_c.html">
            
                    
                    kmalloc.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.4" data-path="../../mm/kmalloc_h.html">
            
                <a href="../../mm/kmalloc_h.html">
            
                    
                    kmalloc.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.5" data-path="../../mm/memlayout_h.html">
            
                <a href="../../mm/memlayout_h.html">
            
                    
                    memlayout.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.6" data-path="../../mm/mmu_h.html">
            
                <a href="../../mm/mmu_h.html">
            
                    
                    mmu.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.7" data-path="../../mm/pmm_c.html">
            
                <a href="../../mm/pmm_c.html">
            
                    
                    pmm.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.8" data-path="../../mm/pmm_h.html">
            
                <a href="../../mm/pmm_h.html">
            
                    
                    pmm.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.9" data-path="../../mm/swap_c.html">
            
                <a href="../../mm/swap_c.html">
            
                    
                    swap.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.10" data-path="../../mm/swap_fifo_c.html">
            
                <a href="../../mm/swap_fifo_c.html">
            
                    
                    swap_fifo.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.11" data-path="../../mm/swap_fifo_h.html">
            
                <a href="../../mm/swap_fifo_h.html">
            
                    
                    swap_fifo.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.12" data-path="../../mm/swap_h.html">
            
                <a href="../../mm/swap_h.html">
            
                    
                    swap.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.13" data-path="../../mm/vmm_c.html">
            
                <a href="../../mm/vmm_c.html">
            
                    
                    vmm.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.14" data-path="../../mm/vmm_h.html">
            
                <a href="../../mm/vmm_h.html">
            
                    
                    vmm.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.15" data-path="../../mm/pmm_c_lab2.html">
            
                <a href="../../mm/pmm_c_lab2.html">
            
                    
                    (lab2) pmm.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6.16" data-path="../../mm/vmm_c_lab3.html">
            
                <a href="../../mm/vmm_c_lab3.html">
            
                    
                    (lab3) vmm.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.7" data-path="../../process/">
            
                <a href="../../process/">
            
                    
                    process
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.7.1" data-path="../../process/entry_S.html">
            
                <a href="../../process/entry_S.html">
            
                    
                    entry.S
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7.2" data-path="../../process/proc_c.html">
            
                <a href="../../process/proc_c.html">
            
                    
                    proc.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7.3" data-path="../../process/proc_h.html">
            
                <a href="../../process/proc_h.html">
            
                    
                    proc.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7.4" data-path="../../process/switch_S.html">
            
                <a href="../../process/switch_S.html">
            
                    
                    switch.S
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7.5" data-path="../../process/proc_c_lab4.html">
            
                <a href="../../process/proc_c_lab4.html">
            
                    
                    (lab4) proc.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7.6" data-path="../../process/proc_c_lab5.html">
            
                <a href="../../process/proc_c_lab5.html">
            
                    
                    (lab5) proc.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.8" data-path="../../schedule/">
            
                <a href="../../schedule/">
            
                    
                    schedule
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.8.1" data-path="../../schedule/default_sched_c.html">
            
                <a href="../../schedule/default_sched_c.html">
            
                    
                    default_sched.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.8.2" data-path="../../schedule/default_sched_h.html">
            
                <a href="../../schedule/default_sched_h.html">
            
                    
                    default_sched.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.8.3" data-path="../../schedule/default_sched_stride_c.html">
            
                <a href="../../schedule/default_sched_stride_c.html">
            
                    
                    default_sched_stride.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.8.4" data-path="../../schedule/sched_c.html">
            
                <a href="../../schedule/sched_c.html">
            
                    
                    sched.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.8.5" data-path="../../schedule/sched_h.html">
            
                <a href="../../schedule/sched_h.html">
            
                    
                    sched.h
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.9" data-path="../../sync/">
            
                <a href="../../sync/">
            
                    
                    sync
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.9.1" data-path="../../sync/check_sync_c.html">
            
                <a href="../../sync/check_sync_c.html">
            
                    
                    check_sync.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9.2" data-path="../../sync/monitor_c.html">
            
                <a href="../../sync/monitor_c.html">
            
                    
                    monitor.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9.3" data-path="../../sync/monitor_h.html">
            
                <a href="../../sync/monitor_h.html">
            
                    
                    monitor.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9.4" data-path="../../sync/sem_c.html">
            
                <a href="../../sync/sem_c.html">
            
                    
                    sem.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9.5" data-path="../../sync/sem_h.html">
            
                <a href="../../sync/sem_h.html">
            
                    
                    sem.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9.6" data-path="../../sync/sync_h.html">
            
                <a href="../../sync/sync_h.html">
            
                    
                    sync.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9.7" data-path="../../sync/wait_c.html">
            
                <a href="../../sync/wait_c.html">
            
                    
                    wait.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9.8" data-path="../../sync/wait_h.html">
            
                <a href="../../sync/wait_h.html">
            
                    
                    wait.h
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.10" data-path="../../syscall/">
            
                <a href="../../syscall/">
            
                    
                    syscall
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.10.1" data-path="../../syscall/syscall_c.html">
            
                <a href="../../syscall/syscall_c.html">
            
                    
                    syscall.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.10.2" data-path="../../syscall/syscall_h.html">
            
                <a href="../../syscall/syscall_h.html">
            
                    
                    syscall.h
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2.11" data-path="../../trap/">
            
                <a href="../../trap/">
            
                    
                    trap
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.11.1" data-path="../../trap/trap_c.html">
            
                <a href="../../trap/trap_c.html">
            
                    
                    trap.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.11.2" data-path="../../trap/trapentry_S.html">
            
                <a href="../../trap/trapentry_S.html">
            
                    
                    trapentry.S
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.11.3" data-path="../../trap/trap_h.html">
            
                <a href="../../trap/trap_h.html">
            
                    
                    trap.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.11.4" data-path="../../trap/vectors_S.html">
            
                <a href="../../trap/vectors_S.html">
            
                    
                    vectors.S
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.11.5" data-path="../../trap/trap_c_lab1.html">
            
                <a href="../../trap/trap_c_lab1.html">
            
                    
                    (lab1) trap.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../../../libs/">
            
                <a href="../../../libs/">
            
                    
                    libs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="../../../libs/atomic_h.html">
            
                <a href="../../../libs/atomic_h.html">
            
                    
                    atomic.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="../../../libs/defs_h.html">
            
                <a href="../../../libs/defs_h.html">
            
                    
                    defs.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="../../../libs/dirent_h.html">
            
                <a href="../../../libs/dirent_h.html">
            
                    
                    dirent.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="../../../libs/elf_h.html">
            
                <a href="../../../libs/elf_h.html">
            
                    
                    elf.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.5" data-path="../../../libs/error_h.html">
            
                <a href="../../../libs/error_h.html">
            
                    
                    error.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.6" data-path="../../../libs/hash_c.html">
            
                <a href="../../../libs/hash_c.html">
            
                    
                    hash.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.7" data-path="../../../libs/list_h.html">
            
                <a href="../../../libs/list_h.html">
            
                    
                    list.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.8" data-path="../../../libs/printfmt_c.html">
            
                <a href="../../../libs/printfmt_c.html">
            
                    
                    printfmt.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.9" data-path="../../../libs/rand_c.html">
            
                <a href="../../../libs/rand_c.html">
            
                    
                    rand.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.10" data-path="../../../libs/skew_heap_h.html">
            
                <a href="../../../libs/skew_heap_h.html">
            
                    
                    skew_heap.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.11" data-path="../../../libs/stat_h.html">
            
                <a href="../../../libs/stat_h.html">
            
                    
                    stat.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.12" data-path="../../../libs/stdarg_h.html">
            
                <a href="../../../libs/stdarg_h.html">
            
                    
                    stdarg.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.13" data-path="../../../libs/stdio_h.html">
            
                <a href="../../../libs/stdio_h.html">
            
                    
                    stdio.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.14" data-path="../../../libs/stdlib_h.html">
            
                <a href="../../../libs/stdlib_h.html">
            
                    
                    stdlib.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.15" data-path="../../../libs/string_c.html">
            
                <a href="../../../libs/string_c.html">
            
                    
                    string.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.16" data-path="../../../libs/string_h.html">
            
                <a href="../../../libs/string_h.html">
            
                    
                    string.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.17" data-path="../../../libs/unistd_h.html">
            
                <a href="../../../libs/unistd_h.html">
            
                    
                    unistd.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.18" data-path="../../../libs/x86_h.html">
            
                <a href="../../../libs/x86_h.html">
            
                    
                    x86.h
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../../../tools/">
            
                <a href="../../../tools/">
            
                    
                    tools
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.4.1" data-path="../../../tools/boot_ld.html">
            
                <a href="../../../tools/boot_ld.html">
            
                    
                    boot.ld
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.2" data-path="../../../tools/function_mk.html">
            
                <a href="../../../tools/function_mk.html">
            
                    
                    function.mk
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.3" data-path="../../../tools/gdbinit.html">
            
                <a href="../../../tools/gdbinit.html">
            
                    
                    gdbinit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.4" data-path="../../../tools/grade_sh.html">
            
                <a href="../../../tools/grade_sh.html">
            
                    
                    grade.sh
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.5" data-path="../../../tools/kernel_ld.html">
            
                <a href="../../../tools/kernel_ld.html">
            
                    
                    kernel.ld
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.6" data-path="../../../tools/mksfs_c.html">
            
                <a href="../../../tools/mksfs_c.html">
            
                    
                    mksfs.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.7" data-path="../../../tools/sign_c.html">
            
                <a href="../../../tools/sign_c.html">
            
                    
                    sign.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.8" data-path="../../../tools/user_ld.html">
            
                <a href="../../../tools/user_ld.html">
            
                    
                    user.ld
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.9" data-path="../../../tools/vector_c.html">
            
                <a href="../../../tools/vector_c.html">
            
                    
                    vector.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../../../user/">
            
                <a href="../../../user/">
            
                    
                    user
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.5.1" data-path="../../../user/libs/">
            
                <a href="../../../user/libs/">
            
                    
                    libs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.5.1.1" data-path="../../../user/libs/dir_c.html">
            
                <a href="../../../user/libs/dir_c.html">
            
                    
                    dir.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.2" data-path="../../../user/libs/dir_h.html">
            
                <a href="../../../user/libs/dir_h.html">
            
                    
                    dir.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.3" data-path="../../../user/libs/file_c.html">
            
                <a href="../../../user/libs/file_c.html">
            
                    
                    file.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.4" data-path="../../../user/libs/file_h.html">
            
                <a href="../../../user/libs/file_h.html">
            
                    
                    file.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.5" data-path="../../../user/libs/initcode_S.html">
            
                <a href="../../../user/libs/initcode_S.html">
            
                    
                    initcode.S
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.6" data-path="../../../user/libs/lock_h.html">
            
                <a href="../../../user/libs/lock_h.html">
            
                    
                    lock.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.7" data-path="../../../user/libs/panic_c.html">
            
                <a href="../../../user/libs/panic_c.html">
            
                    
                    panic.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.8" data-path="../../../user/libs/stdio_c.html">
            
                <a href="../../../user/libs/stdio_c.html">
            
                    
                    stdio.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.9" data-path="../../../user/libs/syscall_c.html">
            
                <a href="../../../user/libs/syscall_c.html">
            
                    
                    syscall.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.10" data-path="../../../user/libs/syscall_h.html">
            
                <a href="../../../user/libs/syscall_h.html">
            
                    
                    syscall.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.11" data-path="../../../user/libs/ulib_c.html">
            
                <a href="../../../user/libs/ulib_c.html">
            
                    
                    ulib.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.12" data-path="../../../user/libs/ulib_h.html">
            
                <a href="../../../user/libs/ulib_h.html">
            
                    
                    ulib.h
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.1.13" data-path="../../../user/libs/umain_c.html">
            
                <a href="../../../user/libs/umain_c.html">
            
                    
                    umain.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.5.2" data-path="../../../user/badarg_c.html">
            
                <a href="../../../user/badarg_c.html">
            
                    
                    badarg.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.3" data-path="../../../user/badsegment_c.html">
            
                <a href="../../../user/badsegment_c.html">
            
                    
                    badsegment.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.4" data-path="../../../user/divzero_c.html">
            
                <a href="../../../user/divzero_c.html">
            
                    
                    divzero.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.5" data-path="../../../user/exit_c.html">
            
                <a href="../../../user/exit_c.html">
            
                    
                    exit.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.6" data-path="../../../user/faultread_c.html">
            
                <a href="../../../user/faultread_c.html">
            
                    
                    faultread.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.7" data-path="../../../user/faultreadkernel_c.html">
            
                <a href="../../../user/faultreadkernel_c.html">
            
                    
                    faultreadkernel.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.8" data-path="../../../user/forktest_c.html">
            
                <a href="../../../user/forktest_c.html">
            
                    
                    forktest.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.9" data-path="../../../user/forktree_c.html">
            
                <a href="../../../user/forktree_c.html">
            
                    
                    forktree.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.10" data-path="../../../user/hello_c.html">
            
                <a href="../../../user/hello_c.html">
            
                    
                    hello.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.11" data-path="../../../user/ls_c.html">
            
                <a href="../../../user/ls_c.html">
            
                    
                    ls.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.12" data-path="../../../user/matrix_c.html">
            
                <a href="../../../user/matrix_c.html">
            
                    
                    matrix.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.13" data-path="../../../user/pgdir_c.html">
            
                <a href="../../../user/pgdir_c.html">
            
                    
                    pgdir.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.14" data-path="../../../user/priority_c.html">
            
                <a href="../../../user/priority_c.html">
            
                    
                    priority.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.15" data-path="../../../user/sfs_filetest1_c.html">
            
                <a href="../../../user/sfs_filetest1_c.html">
            
                    
                    sfs_filetest1.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.16" data-path="../../../user/sh_c.html">
            
                <a href="../../../user/sh_c.html">
            
                    
                    sh.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.17" data-path="../../../user/sleep_c.html">
            
                <a href="../../../user/sleep_c.html">
            
                    
                    sleep.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.18" data-path="../../../user/sleepkill_c.html">
            
                <a href="../../../user/sleepkill_c.html">
            
                    
                    sleepkill.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.19" data-path="../../../user/softint_c.html">
            
                <a href="../../../user/softint_c.html">
            
                    
                    softint.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.20" data-path="../../../user/spin_c.html">
            
                <a href="../../../user/spin_c.html">
            
                    
                    spin.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.21" data-path="../../../user/testbss_c.html">
            
                <a href="../../../user/testbss_c.html">
            
                    
                    testbss.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.22" data-path="../../../user/waitkill_c.html">
            
                <a href="../../../user/waitkill_c.html">
            
                    
                    waitkill.c
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.23" data-path="../../../user/yield_c.html">
            
                <a href="../../../user/yield_c.html">
            
                    
                    yield.c
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../../../Makefile.html">
            
                <a href="../../../Makefile.html">
            
                    
                    Makefile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../../../Makefile_lab1.html">
            
                <a href="../../../Makefile_lab1.html">
            
                    
                    (lab1) Makefile
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../../../how_to_edit_this_doc.html">
            
                <a href="../../../../how_to_edit_this_doc.html">
            
                    
                    附录1：如何编辑该文档
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../../.." >sfs_inode.c</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;defs.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;list.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;kmalloc.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;vfs.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dev.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sfs.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;inode.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iobuf.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bitmap.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;error.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> inode_ops sfs_node_dirops;  <span class="hljs-comment">// dir operations</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> inode_ops sfs_node_fileops; <span class="hljs-comment">// file operations</span>

<span class="hljs-comment">/*
 * lock_sin - lock the process of inode Rd/Wr
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">lock_sin</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>)</span> </span>{
    down(&amp;(<span class="hljs-built_in">sin</span>-&gt;sem));
}

<span class="hljs-comment">/*
 * unlock_sin - unlock the process of inode Rd/Wr
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">unlock_sin</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>)</span> </span>{
    up(&amp;(<span class="hljs-built_in">sin</span>-&gt;sem));
}

<span class="hljs-comment">/*
 * sfs_get_ops - return function addr of fs_node_dirops/sfs_node_fileops
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> inode_ops *
<span class="hljs-title">sfs_get_ops</span><span class="hljs-params">(uint16_t type)</span> </span>{
    <span class="hljs-keyword">switch</span> (type) {
    <span class="hljs-keyword">case</span> SFS_TYPE_DIR:
        <span class="hljs-keyword">return</span> &amp;sfs_node_dirops;
    <span class="hljs-keyword">case</span> SFS_TYPE_FILE:
        <span class="hljs-keyword">return</span> &amp;sfs_node_fileops;
    }
    panic(<span class="hljs-string">&quot;invalid file type %d.\n&quot;</span>, type);
}

<span class="hljs-comment">/*
 * sfs_hash_list - return inode entry in sfs-&gt;hash_list
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> list_entry_t *
<span class="hljs-title">sfs_hash_list</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, uint32_t ino)</span> </span>{
    <span class="hljs-keyword">return</span> sfs-&gt;hash_list + sin_hashfn(ino);
}

<span class="hljs-comment">/*
 * sfs_set_links - link inode sin in sfs-&gt;linked-list AND sfs-&gt;hash_link
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">sfs_set_links</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>)</span> </span>{
    list_add(&amp;(sfs-&gt;inode_list), &amp;(<span class="hljs-built_in">sin</span>-&gt;inode_link));
    list_add(sfs_hash_list(sfs, <span class="hljs-built_in">sin</span>-&gt;ino), &amp;(<span class="hljs-built_in">sin</span>-&gt;hash_link));
}

<span class="hljs-comment">/*
 * sfs_remove_links - unlink inode sin in sfs-&gt;linked-list AND sfs-&gt;hash_link
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">sfs_remove_links</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>)</span> </span>{
    list_del(&amp;(<span class="hljs-built_in">sin</span>-&gt;inode_link));
    list_del(&amp;(<span class="hljs-built_in">sin</span>-&gt;hash_link));
}

<span class="hljs-comment">/*
 * sfs_block_inuse - check the inode with NO. ino inuse info in bitmap
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span>
<span class="hljs-title">sfs_block_inuse</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, uint32_t ino)</span> </span>{
    <span class="hljs-keyword">if</span> (ino != <span class="hljs-number">0</span> &amp;&amp; ino &lt; sfs-&gt;super.blocks) {
        <span class="hljs-keyword">return</span> !bitmap_test(sfs-&gt;freemap, ino);
    }
    panic(<span class="hljs-string">&quot;sfs_block_inuse: called out of range (0, %u) %u.\n&quot;</span>, sfs-&gt;super.blocks, ino);
}

<span class="hljs-comment">/*
 * sfs_block_alloc -  check and get a free disk block
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_block_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, uint32_t *ino_store)</span> </span>{
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">if</span> ((ret = bitmap_alloc(sfs-&gt;freemap, ino_store)) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> ret;
    }
    assert(sfs-&gt;super.unused_blocks &gt; <span class="hljs-number">0</span>);
    sfs-&gt;super.unused_blocks --, sfs-&gt;super_dirty = <span class="hljs-number">1</span>;
    assert(sfs_block_inuse(sfs, *ino_store));
    <span class="hljs-keyword">return</span> sfs_clear_block(sfs, *ino_store, <span class="hljs-number">1</span>);
}

<span class="hljs-comment">/*
 * sfs_block_free - set related bits for ino block to 1(means free) in bitmap, add sfs-&gt;super.unused_blocks, set superblock dirty *
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">sfs_block_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, uint32_t ino)</span> </span>{
    assert(sfs_block_inuse(sfs, ino));
    bitmap_free(sfs-&gt;freemap, ino);
    sfs-&gt;super.unused_blocks ++, sfs-&gt;super_dirty = <span class="hljs-number">1</span>;
}

<span class="hljs-comment">/*
 * sfs_create_inode - alloc a inode in memroy, and init din/ino/dirty/reclian_count/sem fields in sfs_inode in inode
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_create_inode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_disk_inode *din, uint32_t ino, <span class="hljs-keyword">struct</span> inode **node_store)</span> </span>{
    <span class="hljs-keyword">struct</span> inode *node;
    <span class="hljs-keyword">if</span> ((node = alloc_inode(sfs_inode)) != <span class="hljs-literal">NULL</span>) {
        vop_init(node, sfs_get_ops(din-&gt;type), info2fs(sfs, sfs));
        <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);
        <span class="hljs-built_in">sin</span>-&gt;din = din, <span class="hljs-built_in">sin</span>-&gt;ino = ino, <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">0</span>, <span class="hljs-built_in">sin</span>-&gt;reclaim_count = <span class="hljs-number">1</span>;
        sem_init(&amp;(<span class="hljs-built_in">sin</span>-&gt;sem), <span class="hljs-number">1</span>);
        *node_store = node;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> -E_NO_MEM;
}

<span class="hljs-comment">/*
 * lookup_sfs_nolock - according ino, find related inode
 *
 * NOTICE: le2sin, info2node MACRO
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> inode *
<span class="hljs-title">lookup_sfs_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, uint32_t ino)</span> </span>{
    <span class="hljs-keyword">struct</span> inode *node;
    <span class="hljs-keyword">list_entry_t</span> *<span class="hljs-built_in">list</span> = sfs_hash_list(sfs, ino), *le = <span class="hljs-built_in">list</span>;
    <span class="hljs-keyword">while</span> ((le = list_next(le)) != <span class="hljs-built_in">list</span>) {
        <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = le2sin(le, hash_link);
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sin</span>-&gt;ino == ino) {
            node = info2node(<span class="hljs-built_in">sin</span>, sfs_inode);
            <span class="hljs-keyword">if</span> (vop_ref_inc(node) == <span class="hljs-number">1</span>) {
                <span class="hljs-built_in">sin</span>-&gt;reclaim_count ++;
            }
            <span class="hljs-keyword">return</span> node;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}

<span class="hljs-comment">/*
 * sfs_load_inode - If the inode isn&apos;t existed, load inode related ino disk block data into a new created inode.
 *                  If the inode is in memory alreadily, then do nothing
 */</span>
<span class="hljs-function"><span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_load_inode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> inode **node_store, uint32_t ino)</span> </span>{
    lock_sfs_fs(sfs);
    <span class="hljs-keyword">struct</span> inode *node;
    <span class="hljs-keyword">if</span> ((node = lookup_sfs_nolock(sfs, ino)) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">goto</span> out_unlock;
    }

    <span class="hljs-keyword">int</span> ret = -E_NO_MEM;
    <span class="hljs-keyword">struct</span> sfs_disk_inode *din;
    <span class="hljs-keyword">if</span> ((din = kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sfs_disk_inode))) == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">goto</span> failed_unlock;
    }

    assert(sfs_block_inuse(sfs, ino));
    <span class="hljs-keyword">if</span> ((ret = sfs_rbuf(sfs, din, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sfs_disk_inode), ino, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">goto</span> failed_cleanup_din;
    }

    assert(din-&gt;nlinks != <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> ((ret = sfs_create_inode(sfs, din, ino, &amp;node)) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">goto</span> failed_cleanup_din;
    }
    sfs_set_links(sfs, vop_info(node, sfs_inode));

out_unlock:
    unlock_sfs_fs(sfs);
    *node_store = node;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

failed_cleanup_din:
    kfree(din);
failed_unlock:
    unlock_sfs_fs(sfs);
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">/*
 * sfs_bmap_get_sub_nolock - according entry pointer entp and index, find the index of indrect disk block
 *                           return the index of indrect disk block to ino_store. no lock protect
 * @sfs:      sfs file system
 * @entp:     the pointer of index of entry disk block
 * @index:    the index of block in indrect block
 * @create:   BOOL, if the block isn&apos;t allocated, if create = 1 the alloc a block,  otherwise just do nothing
 * @ino_store: 0 OR the index of already inused block or new allocated block.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_bmap_get_sub_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, uint32_t *entp, uint32_t index, <span class="hljs-keyword">bool</span> create, uint32_t *ino_store)</span> </span>{
    assert(index &lt; SFS_BLK_NENTRY);
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">uint32_t</span> ent, ino = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">off_t</span> offset = <span class="hljs-function">index * <span class="hljs-title">sizeof</span><span class="hljs-params">(uint32_t)</span></span>;  <span class="hljs-comment">// the offset of entry in entry block</span>
    <span class="hljs-comment">// if entry block is existd, read the content of entry block into  sfs-&gt;sfs_buffer</span>
    <span class="hljs-keyword">if</span> ((ent = *entp) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> ((ret = sfs_rbuf(sfs, &amp;ino, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">uint32_t</span>), ent, offset)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> ret;
        }
        <span class="hljs-keyword">if</span> (ino != <span class="hljs-number">0</span> || !create) {
            <span class="hljs-keyword">goto</span> out;
        }
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (!create) {
            <span class="hljs-keyword">goto</span> out;
        }
        <span class="hljs-comment">//if entry block isn&apos;t existd, allocated a entry block (for indrect block)</span>
        <span class="hljs-keyword">if</span> ((ret = sfs_block_alloc(sfs, &amp;ent)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> ret;
        }
    }

    <span class="hljs-keyword">if</span> ((ret = sfs_block_alloc(sfs, &amp;ino)) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">goto</span> failed_cleanup;
    }
    <span class="hljs-keyword">if</span> ((ret = sfs_wbuf(sfs, &amp;ino, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">uint32_t</span>), ent, offset)) != <span class="hljs-number">0</span>) {
        sfs_block_free(sfs, ino);
        <span class="hljs-keyword">goto</span> failed_cleanup;
    }

out:
    <span class="hljs-keyword">if</span> (ent != *entp) {
        *entp = ent;
    }
    *ino_store = ino;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

failed_cleanup:
    <span class="hljs-keyword">if</span> (ent != *entp) {
        sfs_block_free(sfs, ent);
    }
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">/*
 * sfs_bmap_get_nolock - according sfs_inode and index of block, find the NO. of disk block
 *                       no lock protect
 * @sfs:      sfs file system
 * @sin:      sfs inode in memory
 * @index:    the index of block in inode
 * @create:   BOOL, if the block isn&apos;t allocated, if create = 1 the alloc a block,  otherwise just do nothing
 * @ino_store: 0 OR the index of already inused block or new allocated block.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_bmap_get_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>, uint32_t index, <span class="hljs-keyword">bool</span> create, uint32_t *ino_store)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_disk_inode *din = <span class="hljs-built_in">sin</span>-&gt;din;
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">uint32_t</span> ent, ino;
    <span class="hljs-comment">// the index of disk block is in the fist SFS_NDIRECT  direct blocks</span>
    <span class="hljs-keyword">if</span> (index &lt; SFS_NDIRECT) {
        <span class="hljs-keyword">if</span> ((ino = din-&gt;direct[index]) == <span class="hljs-number">0</span> &amp;&amp; create) {
            <span class="hljs-keyword">if</span> ((ret = sfs_block_alloc(sfs, &amp;ino)) != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> ret;
            }
            din-&gt;direct[index] = ino;
            <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">goto</span> out;
    }
    <span class="hljs-comment">// the index of disk block is in the indirect blocks.</span>
    index -= SFS_NDIRECT;
    <span class="hljs-keyword">if</span> (index &lt; SFS_BLK_NENTRY) {
        ent = din-&gt;indirect;
        <span class="hljs-keyword">if</span> ((ret = sfs_bmap_get_sub_nolock(sfs, &amp;ent, index, create, &amp;ino)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> ret;
        }
        <span class="hljs-keyword">if</span> (ent != din-&gt;indirect) {
            assert(din-&gt;indirect == <span class="hljs-number">0</span>);
            din-&gt;indirect = ent;
            <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">goto</span> out;
    } <span class="hljs-keyword">else</span> {
        panic (<span class="hljs-string">&quot;sfs_bmap_get_nolock - index out of range&quot;</span>);
    }
out:
    assert(ino == <span class="hljs-number">0</span> || sfs_block_inuse(sfs, ino));
    *ino_store = ino;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">/*
 * sfs_bmap_free_sub_nolock - set the entry item to 0 (free) in the indirect block
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_bmap_free_sub_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, uint32_t ent, uint32_t index)</span> </span>{
    assert(sfs_block_inuse(sfs, ent) &amp;&amp; index &lt; SFS_BLK_NENTRY);
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">uint32_t</span> ino, zero = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">off_t</span> offset = <span class="hljs-function">index * <span class="hljs-title">sizeof</span><span class="hljs-params">(uint32_t)</span></span>;
    <span class="hljs-keyword">if</span> ((ret = sfs_rbuf(sfs, &amp;ino, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">uint32_t</span>), ent, offset)) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> ret;
    }
    <span class="hljs-keyword">if</span> (ino != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> ((ret = sfs_wbuf(sfs, &amp;zero, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">uint32_t</span>), ent, offset)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> ret;
        }
        sfs_block_free(sfs, ino);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">/*
 * sfs_bmap_free_nolock - free a block with logical index in inode and reset the inode&apos;s fields
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_bmap_free_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>, uint32_t index)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_disk_inode *din = <span class="hljs-built_in">sin</span>-&gt;din;
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">uint32_t</span> ent, ino;
    <span class="hljs-keyword">if</span> (index &lt; SFS_NDIRECT) {
        <span class="hljs-keyword">if</span> ((ino = din-&gt;direct[index]) != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// free the block</span>
            sfs_block_free(sfs, ino);
            din-&gt;direct[index] = <span class="hljs-number">0</span>;
            <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    index -= SFS_NDIRECT;
    <span class="hljs-keyword">if</span> (index &lt; SFS_BLK_NENTRY) {
        <span class="hljs-keyword">if</span> ((ent = din-&gt;indirect) != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// set the entry item to 0 in the indirect block</span>
            <span class="hljs-keyword">if</span> ((ret = sfs_bmap_free_sub_nolock(sfs, ent, index)) != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> ret;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">/*
 * sfs_bmap_load_nolock - according to the DIR&apos;s inode and the logical index of block in inode, find the NO. of disk block.
 * @sfs:      sfs file system
 * @sin:      sfs inode in memory
 * @index:    the logical index of disk block in inode
 * @ino_store:the NO. of disk block
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_bmap_load_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>, uint32_t index, uint32_t *ino_store)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_disk_inode *din = <span class="hljs-built_in">sin</span>-&gt;din;
    assert(index &lt;= din-&gt;blocks);
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">uint32_t</span> ino;
    <span class="hljs-keyword">bool</span> create = (index == din-&gt;blocks);
    <span class="hljs-keyword">if</span> ((ret = sfs_bmap_get_nolock(sfs, <span class="hljs-built_in">sin</span>, index, create, &amp;ino)) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> ret;
    }
    assert(sfs_block_inuse(sfs, ino));
    <span class="hljs-keyword">if</span> (create) {
        din-&gt;blocks ++;
    }
    <span class="hljs-keyword">if</span> (ino_store != <span class="hljs-literal">NULL</span>) {
        *ino_store = ino;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">/*
 * sfs_bmap_truncate_nolock - free the disk block at the end of file
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_bmap_truncate_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_disk_inode *din = <span class="hljs-built_in">sin</span>-&gt;din;
    assert(din-&gt;blocks != <span class="hljs-number">0</span>);
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">if</span> ((ret = sfs_bmap_free_nolock(sfs, <span class="hljs-built_in">sin</span>, din-&gt;blocks - <span class="hljs-number">1</span>)) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> ret;
    }
    din-&gt;blocks --;
    <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">/*
 * sfs_dirent_read_nolock - read the file entry from disk block which contains this entry
 * @sfs:      sfs file system
 * @sin:      sfs inode in memory
 * @slot:     the index of file entry
 * @entry:    file entry
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_dirent_read_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">int</span> slot, <span class="hljs-keyword">struct</span> sfs_disk_entry *entry)</span> </span>{
    assert(<span class="hljs-built_in">sin</span>-&gt;din-&gt;type == SFS_TYPE_DIR &amp;&amp; (slot &gt;= <span class="hljs-number">0</span> &amp;&amp; slot &lt; <span class="hljs-built_in">sin</span>-&gt;din-&gt;blocks));
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">uint32_t</span> ino;
    <span class="hljs-comment">// according to the DIR&apos;s inode and the slot of file entry, find the index of disk block which contains this file entry</span>
    <span class="hljs-keyword">if</span> ((ret = sfs_bmap_load_nolock(sfs, <span class="hljs-built_in">sin</span>, slot, &amp;ino)) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> ret;
    }
    assert(sfs_block_inuse(sfs, ino));
    <span class="hljs-comment">// read the content of file entry in the disk block </span>
    <span class="hljs-keyword">if</span> ((ret = sfs_rbuf(sfs, entry, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sfs_disk_entry), ino, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> ret;
    }
    entry-&gt;name[SFS_MAX_FNAME_LEN] = <span class="hljs-string">&apos;\0&apos;</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> sfs_dirent_link_nolock_check(sfs, sin, slot, lnksin, name)                  \
    do {                                                                            \
        int err;                                                                    \
        <span class="hljs-meta-keyword">if</span> ((err = sfs_dirent_link_nolock(sfs, sin, slot, lnksin, name)) != 0) {    \
            warn(<span class="hljs-string">&quot;sfs_dirent_link error: %e.\n&quot;</span>, err);                              \
        }                                                                           \
    } while (0)</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> sfs_dirent_unlink_nolock_check(sfs, sin, slot, lnksin)                      \
    do {                                                                            \
        int err;                                                                    \
        <span class="hljs-meta-keyword">if</span> ((err = sfs_dirent_unlink_nolock(sfs, sin, slot, lnksin)) != 0) {        \
            warn(<span class="hljs-string">&quot;sfs_dirent_unlink error: %e.\n&quot;</span>, err);                            \
        }                                                                           \
    } while (0)</span>

<span class="hljs-comment">/*
 * sfs_dirent_search_nolock - read every file entry in the DIR, compare file name with each entry-&gt;name
 *                            If equal, then return slot and NO. of disk of this file&apos;s inode
 * @sfs:        sfs file system
 * @sin:        sfs inode in memory
 * @name:       the filename
 * @ino_store:  NO. of disk of this file (with the filename)&apos;s inode
 * @slot:       logical index of file entry (NOTICE: each file entry ocupied one  disk block)
 * @empty_slot: the empty logical index of file entry.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_dirent_search_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name, uint32_t *ino_store, <span class="hljs-keyword">int</span> *slot, <span class="hljs-keyword">int</span> *empty_slot)</span> </span>{
    assert(<span class="hljs-built_in">strlen</span>(name) &lt;= SFS_MAX_FNAME_LEN);
    <span class="hljs-keyword">struct</span> sfs_disk_entry *entry;
    <span class="hljs-keyword">if</span> ((entry = kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sfs_disk_entry))) == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> -E_NO_MEM;
    }

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> set_pvalue(x, v)            do { <span class="hljs-meta-keyword">if</span> ((x) != NULL) { *(x) = (v); } } while (0)</span>
    <span class="hljs-keyword">int</span> ret, i, nslots = <span class="hljs-built_in">sin</span>-&gt;din-&gt;blocks;
    set_pvalue(empty_slot, nslots);
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nslots; i ++) {
        <span class="hljs-keyword">if</span> ((ret = sfs_dirent_read_nolock(sfs, <span class="hljs-built_in">sin</span>, i, entry)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> out;
        }
        <span class="hljs-keyword">if</span> (entry-&gt;ino == <span class="hljs-number">0</span>) {
            set_pvalue(empty_slot, i);
            <span class="hljs-keyword">continue</span> ;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(name, entry-&gt;name) == <span class="hljs-number">0</span>) {
            set_pvalue(slot, i);
            set_pvalue(ino_store, entry-&gt;ino);
            <span class="hljs-keyword">goto</span> out;
        }
    }
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> set_pvalue</span>
    ret = -E_NOENT;
out:
    kfree(entry);
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">/*
 * sfs_dirent_findino_nolock - read all file entries in DIR&apos;s inode and find a entry-&gt;ino == ino
 */</span>

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_dirent_findino_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>, uint32_t ino, <span class="hljs-keyword">struct</span> sfs_disk_entry *entry)</span> </span>{
    <span class="hljs-keyword">int</span> ret, i, nslots = <span class="hljs-built_in">sin</span>-&gt;din-&gt;blocks;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nslots; i ++) {
        <span class="hljs-keyword">if</span> ((ret = sfs_dirent_read_nolock(sfs, <span class="hljs-built_in">sin</span>, i, entry)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> ret;
        }
        <span class="hljs-keyword">if</span> (entry-&gt;ino == ino) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
    <span class="hljs-keyword">return</span> -E_NOENT;
}

<span class="hljs-comment">/*
 * sfs_lookup_once - find inode corresponding the file name in DIR&apos;s sin inode 
 * @sfs:        sfs file system
 * @sin:        DIR sfs inode in memory
 * @name:       the file name in DIR
 * @node_store: the inode corresponding the file name in DIR
 * @slot:       the logical index of file entry
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_lookup_once</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name, <span class="hljs-keyword">struct</span> inode **node_store, <span class="hljs-keyword">int</span> *slot)</span> </span>{
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">uint32_t</span> ino;
    lock_sin(<span class="hljs-built_in">sin</span>);
    {   <span class="hljs-comment">// find the NO. of disk block and logical index of file entry</span>
        ret = sfs_dirent_search_nolock(sfs, <span class="hljs-built_in">sin</span>, name, &amp;ino, slot, <span class="hljs-literal">NULL</span>);
    }
    unlock_sin(<span class="hljs-built_in">sin</span>);
    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// load the content of inode with the the NO. of disk block</span>
        ret = sfs_load_inode(sfs, node_store, ino);
    }
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">// sfs_opendir - just check the opne_flags, now support readonly</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_opendir</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, uint32_t open_flags)</span> </span>{
    <span class="hljs-keyword">switch</span> (open_flags &amp; O_ACCMODE) {
    <span class="hljs-keyword">case</span> O_RDONLY:
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> O_WRONLY:
    <span class="hljs-keyword">case</span> O_RDWR:
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> -E_ISDIR;
    }
    <span class="hljs-keyword">if</span> (open_flags &amp; O_APPEND) {
        <span class="hljs-keyword">return</span> -E_ISDIR;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// sfs_openfile - open file (no use)</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_openfile</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, uint32_t open_flags)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// sfs_close - close file</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_close</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node)</span> </span>{
    <span class="hljs-keyword">return</span> vop_fsync(node);
}

<span class="hljs-comment">/*  
 * sfs_io_nolock - Rd/Wr a file contentfrom offset position to offset+ length  disk blocks&lt;--&gt;buffer (in memroy)
 * @sfs:      sfs file system
 * @sin:      sfs inode in memory
 * @buf:      the buffer Rd/Wr
 * @offset:   the offset of file
 * @alenp:    the length need to read (is a pointer). and will RETURN the really Rd/Wr lenght
 * @write:    BOOL, 0 read, 1 write
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_io_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">void</span> *buf, off_t offset, size_t *alenp, <span class="hljs-keyword">bool</span> write)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_disk_inode *din = <span class="hljs-built_in">sin</span>-&gt;din;
    assert(din-&gt;type != SFS_TYPE_DIR);
    <span class="hljs-keyword">off_t</span> endpos = offset + *alenp, blkoff;
    *alenp = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// calculate the Rd/Wr end position</span>
    <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span> || offset &gt;= SFS_MAX_FILE_SIZE || offset &gt; endpos) {
        <span class="hljs-keyword">return</span> -E_INVAL;
    }
    <span class="hljs-keyword">if</span> (offset == endpos) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">if</span> (endpos &gt; SFS_MAX_FILE_SIZE) {
        endpos = SFS_MAX_FILE_SIZE;
    }
    <span class="hljs-keyword">if</span> (!write) {
        <span class="hljs-keyword">if</span> (offset &gt;= din-&gt;size) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">if</span> (endpos &gt; din-&gt;size) {
            endpos = din-&gt;size;
        }
    }

    <span class="hljs-keyword">int</span> (*sfs_buf_op)(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">size_t</span> len, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">off_t</span> offset);
    <span class="hljs-keyword">int</span> (*sfs_block_op)(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">uint32_t</span> blkno, <span class="hljs-keyword">uint32_t</span> nblks);
    <span class="hljs-keyword">if</span> (write) {
        sfs_buf_op = sfs_wbuf, sfs_block_op = sfs_wblock;
    }
    <span class="hljs-keyword">else</span> {
        sfs_buf_op = sfs_rbuf, sfs_block_op = sfs_rblock;
    }

    <span class="hljs-keyword">int</span> ret = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">size_t</span> size, alen = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">uint32_t</span> ino;
    <span class="hljs-keyword">uint32_t</span> blkno = offset / SFS_BLKSIZE;          <span class="hljs-comment">// The NO. of Rd/Wr begin block</span>
    <span class="hljs-keyword">uint32_t</span> nblks = endpos / SFS_BLKSIZE - blkno;  <span class="hljs-comment">// The size of Rd/Wr blocks</span>

  <span class="hljs-comment">//LAB8:EXERCISE1 YOUR CODE HINT: call sfs_bmap_load_nolock, sfs_rbuf, sfs_rblock,etc. read different kind of blocks in file</span>
    <span class="hljs-comment">/*
     * (1) If offset isn&apos;t aligned with the first block, Rd/Wr some content from offset to the end of the first block
     *       NOTICE: useful function: sfs_bmap_load_nolock, sfs_buf_op
     *               Rd/Wr size = (nblks != 0) ? (SFS_BLKSIZE - blkoff) : (endpos - offset)
     * (2) Rd/Wr aligned blocks 
     *       NOTICE: useful function: sfs_bmap_load_nolock, sfs_block_op
     * (3) If end position isn&apos;t aligned with the last block, Rd/Wr some content from begin to the (endpos % SFS_BLKSIZE) of the last block
     *       NOTICE: useful function: sfs_bmap_load_nolock, sfs_buf_op    
    */</span>
    <span class="hljs-keyword">if</span> ((blkoff = offset % SFS_BLKSIZE) != <span class="hljs-number">0</span>) {
        size = (nblks != <span class="hljs-number">0</span>) ? (SFS_BLKSIZE - blkoff) : (endpos - offset);
        <span class="hljs-keyword">if</span> ((ret = sfs_bmap_load_nolock(sfs, <span class="hljs-built_in">sin</span>, blkno, &amp;ino)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> out;
        }
        <span class="hljs-keyword">if</span> ((ret = sfs_buf_op(sfs, buf, size, ino, blkoff)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> out;
        }
        alen += size;
        <span class="hljs-keyword">if</span> (nblks == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> out;
        }
        buf += size, blkno ++, nblks --;
    }

    size = SFS_BLKSIZE;
    <span class="hljs-keyword">while</span> (nblks != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> ((ret = sfs_bmap_load_nolock(sfs, <span class="hljs-built_in">sin</span>, blkno, &amp;ino)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> out;
        }
        <span class="hljs-keyword">if</span> ((ret = sfs_block_op(sfs, buf, ino, <span class="hljs-number">1</span>)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> out;
        }
        alen += size, buf += size, blkno ++, nblks --;
    }

    <span class="hljs-keyword">if</span> ((size = endpos % SFS_BLKSIZE) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> ((ret = sfs_bmap_load_nolock(sfs, <span class="hljs-built_in">sin</span>, blkno, &amp;ino)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> out;
        }
        <span class="hljs-keyword">if</span> ((ret = sfs_buf_op(sfs, buf, size, ino, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> out;
        }
        alen += size;
    }
out:
    *alenp = alen;
    <span class="hljs-keyword">if</span> (offset + alen &gt; <span class="hljs-built_in">sin</span>-&gt;din-&gt;size) {
        <span class="hljs-built_in">sin</span>-&gt;din-&gt;size = offset + alen;
        <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">/*
 * sfs_io - Rd/Wr file. the wrapper of sfs_io_nolock
            with lock protect
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_io</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, <span class="hljs-keyword">struct</span> iobuf *iob, <span class="hljs-keyword">bool</span> write)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_fs *sfs = fsop_info(vop_fs(node), sfs);
    <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);
    <span class="hljs-keyword">int</span> ret;
    lock_sin(<span class="hljs-built_in">sin</span>);
    {
        <span class="hljs-keyword">size_t</span> alen = iob-&gt;io_resid;
        ret = sfs_io_nolock(sfs, <span class="hljs-built_in">sin</span>, iob-&gt;io_base, iob-&gt;io_offset, &amp;alen, write);
        <span class="hljs-keyword">if</span> (alen != <span class="hljs-number">0</span>) {
            iobuf_skip(iob, alen);
        }
    }
    unlock_sin(<span class="hljs-built_in">sin</span>);
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">// sfs_read - read file</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, <span class="hljs-keyword">struct</span> iobuf *iob)</span> </span>{
    <span class="hljs-keyword">return</span> sfs_io(node, iob, <span class="hljs-number">0</span>);
}

<span class="hljs-comment">// sfs_write - write file</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, <span class="hljs-keyword">struct</span> iobuf *iob)</span> </span>{
    <span class="hljs-keyword">return</span> sfs_io(node, iob, <span class="hljs-number">1</span>);
}

<span class="hljs-comment">/*
 * sfs_fstat - Return nlinks/block/size, etc. info about a file. The pointer is a pointer to struct stat;
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_fstat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, <span class="hljs-keyword">struct</span> stat *stat)</span> </span>{
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-built_in">memset</span>(stat, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> stat));
    <span class="hljs-keyword">if</span> ((ret = vop_gettype(node, &amp;(stat-&gt;st_mode))) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> ret;
    }
    <span class="hljs-keyword">struct</span> sfs_disk_inode *din = vop_info(node, sfs_inode)-&gt;din;
    stat-&gt;st_nlinks = din-&gt;nlinks;
    stat-&gt;st_blocks = din-&gt;blocks;
    stat-&gt;st_size = din-&gt;size;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">/*
 * sfs_fsync - Force any dirty inode info associated with this file to stable storage.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_fsync</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_fs *sfs = fsop_info(vop_fs(node), sfs);
    <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);
    <span class="hljs-keyword">int</span> ret = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sin</span>-&gt;dirty) {
        lock_sin(<span class="hljs-built_in">sin</span>);
        {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sin</span>-&gt;dirty) {
                <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">if</span> ((ret = sfs_wbuf(sfs, <span class="hljs-built_in">sin</span>-&gt;din, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sfs_disk_inode), <span class="hljs-built_in">sin</span>-&gt;ino, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>) {
                    <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">1</span>;
                }
            }
        }
        unlock_sin(<span class="hljs-built_in">sin</span>);
    }
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">/*
 *sfs_namefile -Compute pathname relative to filesystem root of the file and copy to the specified io buffer.
 *  
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_namefile</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, <span class="hljs-keyword">struct</span> iobuf *iob)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_disk_entry *entry;
    <span class="hljs-keyword">if</span> (iob-&gt;io_resid &lt;= <span class="hljs-number">2</span> || (entry = kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sfs_disk_entry))) == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> -E_NO_MEM;
    }

    <span class="hljs-keyword">struct</span> sfs_fs *sfs = fsop_info(vop_fs(node), sfs);
    <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);

    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">char</span> *ptr = iob-&gt;io_base + iob-&gt;io_resid;
    <span class="hljs-keyword">size_t</span> alen, resid = iob-&gt;io_resid - <span class="hljs-number">2</span>;
    vop_ref_inc(node);
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">struct</span> inode *parent;
        <span class="hljs-keyword">if</span> ((ret = sfs_lookup_once(sfs, <span class="hljs-built_in">sin</span>, <span class="hljs-string">&quot;..&quot;</span>, &amp;parent, <span class="hljs-literal">NULL</span>)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> failed;
        }

        <span class="hljs-keyword">uint32_t</span> ino = <span class="hljs-built_in">sin</span>-&gt;ino;
        vop_ref_dec(node);
        <span class="hljs-keyword">if</span> (node == parent) {
            vop_ref_dec(node);
            <span class="hljs-keyword">break</span>;
        }

        node = parent, <span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);
        assert(ino != <span class="hljs-built_in">sin</span>-&gt;ino &amp;&amp; <span class="hljs-built_in">sin</span>-&gt;din-&gt;type == SFS_TYPE_DIR);

        lock_sin(<span class="hljs-built_in">sin</span>);
        {
            ret = sfs_dirent_findino_nolock(sfs, <span class="hljs-built_in">sin</span>, ino, entry);
        }
        unlock_sin(<span class="hljs-built_in">sin</span>);

        <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> failed;
        }

        <span class="hljs-keyword">if</span> ((alen = <span class="hljs-built_in">strlen</span>(entry-&gt;name) + <span class="hljs-number">1</span>) &gt; resid) {
            <span class="hljs-keyword">goto</span> failed_nomem;
        }
        resid -= alen, ptr -= alen;
        <span class="hljs-built_in">memcpy</span>(ptr, entry-&gt;name, alen - <span class="hljs-number">1</span>);
        ptr[alen - <span class="hljs-number">1</span>] = <span class="hljs-string">&apos;/&apos;</span>;
    }
    alen = iob-&gt;io_resid - resid - <span class="hljs-number">2</span>;
    ptr = memmove(iob-&gt;io_base + <span class="hljs-number">1</span>, ptr, alen);
    ptr[<span class="hljs-number">-1</span>] = <span class="hljs-string">&apos;/&apos;</span>, ptr[alen] = <span class="hljs-string">&apos;\0&apos;</span>;
    iobuf_skip(iob, alen);
    kfree(entry);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

failed_nomem:
    ret = -E_NO_MEM;
failed:
    vop_ref_dec(node);
    kfree(entry);
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">/*
 * sfs_getdirentry_sub_noblock - get the content of file entry in DIR
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_getdirentry_sub_nolock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sfs_fs *sfs, <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">int</span> slot, <span class="hljs-keyword">struct</span> sfs_disk_entry *entry)</span> </span>{
    <span class="hljs-keyword">int</span> ret, i, nslots = <span class="hljs-built_in">sin</span>-&gt;din-&gt;blocks;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nslots; i ++) {
        <span class="hljs-keyword">if</span> ((ret = sfs_dirent_read_nolock(sfs, <span class="hljs-built_in">sin</span>, i, entry)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> ret;
        }
        <span class="hljs-keyword">if</span> (entry-&gt;ino != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> (slot == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            slot --;
        }
    }
    <span class="hljs-keyword">return</span> -E_NOENT;
}

<span class="hljs-comment">/*
 * sfs_getdirentry - according to the iob-&gt;io_offset, calculate the dir entry&apos;s slot in disk block,
                     get dir entry content from the disk 
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_getdirentry</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, <span class="hljs-keyword">struct</span> iobuf *iob)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_disk_entry *entry;
    <span class="hljs-keyword">if</span> ((entry = kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sfs_disk_entry))) == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> -E_NO_MEM;
    }

    <span class="hljs-keyword">struct</span> sfs_fs *sfs = fsop_info(vop_fs(node), sfs);
    <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);

    <span class="hljs-keyword">int</span> ret, slot;
    <span class="hljs-keyword">off_t</span> offset = iob-&gt;io_offset;
    <span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span> || offset % sfs_dentry_size != <span class="hljs-number">0</span>) {
        kfree(entry);
        <span class="hljs-keyword">return</span> -E_INVAL;
    }
    <span class="hljs-keyword">if</span> ((slot = offset / sfs_dentry_size) &gt; <span class="hljs-built_in">sin</span>-&gt;din-&gt;blocks) {
        kfree(entry);
        <span class="hljs-keyword">return</span> -E_NOENT;
    }
    lock_sin(<span class="hljs-built_in">sin</span>);
    <span class="hljs-keyword">if</span> ((ret = sfs_getdirentry_sub_nolock(sfs, <span class="hljs-built_in">sin</span>, slot, entry)) != <span class="hljs-number">0</span>) {
        unlock_sin(<span class="hljs-built_in">sin</span>);
        <span class="hljs-keyword">goto</span> out;
    }
    unlock_sin(<span class="hljs-built_in">sin</span>);
    ret = iobuf_move(iob, entry-&gt;name, sfs_dentry_size, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>);
out:
    kfree(entry);
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">/*
 * sfs_reclaim - Free all resources inode occupied . Called when inode is no longer in use. 
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_reclaim</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_fs *sfs = fsop_info(vop_fs(node), sfs);
    <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);

    <span class="hljs-keyword">int</span>  ret = -E_BUSY;
    <span class="hljs-keyword">uint32_t</span> ent;
    lock_sfs_fs(sfs);
    assert(<span class="hljs-built_in">sin</span>-&gt;reclaim_count &gt; <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> ((-- <span class="hljs-built_in">sin</span>-&gt;reclaim_count) != <span class="hljs-number">0</span> || inode_ref_count(node) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">goto</span> failed_unlock;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sin</span>-&gt;din-&gt;nlinks == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> ((ret = vop_truncate(node, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> failed_unlock;
        }
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sin</span>-&gt;dirty) {
        <span class="hljs-keyword">if</span> ((ret = vop_fsync(node)) != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">goto</span> failed_unlock;
        }
    }
    sfs_remove_links(<span class="hljs-built_in">sin</span>);
    unlock_sfs_fs(sfs);

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sin</span>-&gt;din-&gt;nlinks == <span class="hljs-number">0</span>) {
        sfs_block_free(sfs, <span class="hljs-built_in">sin</span>-&gt;ino);
        <span class="hljs-keyword">if</span> ((ent = <span class="hljs-built_in">sin</span>-&gt;din-&gt;indirect) != <span class="hljs-number">0</span>) {
            sfs_block_free(sfs, ent);
        }
    }
    kfree(<span class="hljs-built_in">sin</span>-&gt;din);
    vop_kill(node);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

failed_unlock:
    unlock_sfs_fs(sfs);
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">/*
 * sfs_gettype - Return type of file. The values for file types are in sfs.h.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_gettype</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, uint32_t *type_store)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_disk_inode *din = vop_info(node, sfs_inode)-&gt;din;
    <span class="hljs-keyword">switch</span> (din-&gt;type) {
    <span class="hljs-keyword">case</span> SFS_TYPE_DIR:
        *type_store = S_IFDIR;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">case</span> SFS_TYPE_FILE:
        *type_store = S_IFREG;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">case</span> SFS_TYPE_LINK:
        *type_store = S_IFLNK;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    panic(<span class="hljs-string">&quot;invalid file type %d.\n&quot;</span>, din-&gt;type);
}

<span class="hljs-comment">/* 
 * sfs_tryseek - Check if seeking to the specified position within the file is legal.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_tryseek</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, off_t pos)</span> </span>{
    <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span> || pos &gt;= SFS_MAX_FILE_SIZE) {
        <span class="hljs-keyword">return</span> -E_INVAL;
    }
    <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);
    <span class="hljs-keyword">if</span> (pos &gt; <span class="hljs-built_in">sin</span>-&gt;din-&gt;size) {
        <span class="hljs-keyword">return</span> vop_truncate(node, pos);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">/*
 * sfs_truncfile : reszie the file with new length
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_truncfile</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, off_t len)</span> </span>{
    <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span> || len &gt; SFS_MAX_FILE_SIZE) {
        <span class="hljs-keyword">return</span> -E_INVAL;
    }
    <span class="hljs-keyword">struct</span> sfs_fs *sfs = fsop_info(vop_fs(node), sfs);
    <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);
    <span class="hljs-keyword">struct</span> sfs_disk_inode *din = <span class="hljs-built_in">sin</span>-&gt;din;

    <span class="hljs-keyword">int</span> ret = <span class="hljs-number">0</span>;
    <span class="hljs-comment">//new number of disk blocks of file</span>
    <span class="hljs-keyword">uint32_t</span> nblks, tblks = ROUNDUP_DIV(len, SFS_BLKSIZE);
    <span class="hljs-keyword">if</span> (din-&gt;size == len) {
        assert(tblks == din-&gt;blocks);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    lock_sin(<span class="hljs-built_in">sin</span>);
    <span class="hljs-comment">// old number of disk blocks of file</span>
    nblks = din-&gt;blocks;
    <span class="hljs-keyword">if</span> (nblks &lt; tblks) {
        <span class="hljs-comment">// try to enlarge the file size by add new disk block at the end of file</span>
        <span class="hljs-keyword">while</span> (nblks != tblks) {
            <span class="hljs-keyword">if</span> ((ret = sfs_bmap_load_nolock(sfs, <span class="hljs-built_in">sin</span>, nblks, <span class="hljs-literal">NULL</span>)) != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">goto</span> out_unlock;
            }
            nblks ++;
        }
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tblks &lt; nblks) {
        <span class="hljs-comment">// try to reduce the file size </span>
        <span class="hljs-keyword">while</span> (tblks != nblks) {
            <span class="hljs-keyword">if</span> ((ret = sfs_bmap_truncate_nolock(sfs, <span class="hljs-built_in">sin</span>)) != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">goto</span> out_unlock;
            }
            nblks --;
        }
    }
    assert(din-&gt;blocks == tblks);
    din-&gt;size = len;
    <span class="hljs-built_in">sin</span>-&gt;dirty = <span class="hljs-number">1</span>;

out_unlock:
    unlock_sin(<span class="hljs-built_in">sin</span>);
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-comment">/*
 * sfs_lookup - Parse path relative to the passed directory
 *              DIR, and hand back the inode for the file it
 *              refers to.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">sfs_lookup</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *node, <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">struct</span> inode **node_store)</span> </span>{
    <span class="hljs-keyword">struct</span> sfs_fs *sfs = fsop_info(vop_fs(node), sfs);
    assert(*path != <span class="hljs-string">&apos;\0&apos;</span> &amp;&amp; *path != <span class="hljs-string">&apos;/&apos;</span>);
    vop_ref_inc(node);
    <span class="hljs-keyword">struct</span> sfs_inode *<span class="hljs-built_in">sin</span> = vop_info(node, sfs_inode);
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sin</span>-&gt;din-&gt;type != SFS_TYPE_DIR) {
        vop_ref_dec(node);
        <span class="hljs-keyword">return</span> -E_NOTDIR;
    }
    <span class="hljs-keyword">struct</span> inode *subnode;
    <span class="hljs-keyword">int</span> ret = sfs_lookup_once(sfs, <span class="hljs-built_in">sin</span>, path, &amp;subnode, <span class="hljs-literal">NULL</span>);

    vop_ref_dec(node);
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> ret;
    }
    *node_store = subnode;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// The sfs specific DIR operations correspond to the abstract operations on a inode.</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> inode_ops sfs_node_dirops = {
    .vop_magic                      = VOP_MAGIC,
    .vop_open                       = sfs_opendir,
    .vop_close                      = sfs_close,
    .vop_fstat                      = sfs_fstat,
    .vop_fsync                      = sfs_fsync,
    .vop_namefile                   = sfs_namefile,
    .vop_getdirentry                = sfs_getdirentry,
    .vop_reclaim                    = sfs_reclaim,
    .vop_gettype                    = sfs_gettype,
    .vop_lookup                     = sfs_lookup,
};
<span class="hljs-comment">/// The sfs specific FILE operations correspond to the abstract operations on a inode.</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> inode_ops sfs_node_fileops = {
    .vop_magic                      = VOP_MAGIC,
    .vop_open                       = sfs_openfile,
    .vop_close                      = sfs_close,
    .vop_read                       = sfs_read,
    .vop_write                      = sfs_write,
    .vop_fstat                      = sfs_fstat,
    .vop_fsync                      = sfs_fsync,
    .vop_reclaim                    = sfs_reclaim,
    .vop_gettype                    = sfs_gettype,
    .vop_tryseek                    = sfs_tryseek,
    .vop_truncate                   = sfs_truncfile,
};
</code></pre>
<p><div id="page-footer" class="localized-footer"><hr><p><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"></p>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<div id="gitalk-container" style="margin: 5%"></div>
<script>
  const gitalk = new Gitalk({
    clientID: '04fb515964c291ec14f6',
    clientSecret: 'd3f22dae66101b238ab91929dc6658952d0c4050',
    repo: 'ucore-analysis',
    owner: 'oscourse-tsinghua',
    admin: ['xyongcn'],
    createIssueManually: true,
    id: document.title
  })
  gitalk.render('gitalk-container')
</script>
<script>
  require(['gitbook'], function(gitbook) {
    const gitalk = new Gitalk({
      clientID: '04fb515964c291ec14f6',
      clientSecret: 'd3f22dae66101b238ab91929dc6658952d0c4050',
      repo: 'ucore-analysis',
      owner: 'oscourse-tsinghua',
      admin: ['xyongcn'],
      createIssueManually: true,
      id: document.title
    })
    gitbook.events.bind('page.change', initMygitalk)
    function initMygitalk() {
      gitalk.render('gitalk-container')
    }
  })
</script>
</div></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="sfs_h.html" class="navigation navigation-prev " aria-label="Previous page: sfs.h">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="sfs_io_c.html" class="navigation navigation-next " aria-label="Next page: sfs_io.c">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"sfs_inode.c","level":"1.3.2.3.2.6","depth":5,"next":{"title":"sfs_io.c","level":"1.3.2.3.2.7","depth":5,"path":"ucore/kern/fs/sfs/sfs_io_c.md","ref":"ucore/kern/fs/sfs/sfs_io_c.md","articles":[]},"previous":{"title":"sfs.h","level":"1.3.2.3.2.5","depth":5,"path":"ucore/kern/fs/sfs/sfs_h.md","ref":"ucore/kern/fs/sfs/sfs_h.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["chapter-fold","code","search-pro","github","localized-footer","ancre-navigation","-sharing"],"pluginsConfig":{"chapter-fold":{},"github":{"url":"https://oscourse-tsinghua.github.io/ucore-analysis"},"search-pro":{},"search":{},"localized-footer":{"filename":"gitbook/comment.html","hline":"true"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"ancre-navigation":{"associatedWithSummary":true,"float":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"mode":"float","multipleH1":true,"pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"printLog":false,"showLevel":true},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"gitbook/website.css"}},"file":{"path":"ucore/kern/fs/sfs/sfs_inode_c.md","mtime":"2019-10-30T01:02:04.780Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-10-30T02:19:17.285Z"},"basePath":"../../../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../../../gitbook/gitbook.js"></script>
    <script src="../../../../gitbook/theme.js"></script>
    
        
        <script src="../../../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

